{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load crispy_forms_field %}


{% block page_css %}
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link href="{% static 'plugins/flatpickr/flatpickr.css' %}" rel="stylesheet" type="text/css">

    <!-- END THEME GLOBAL STYLES -->

    <!--  BEGIN CUSTOM STYLE FILE  -->

    <link href="{% static 'plugins/flatpickr/custom-flatpickr.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'plugins/animate/animate.css' %}" rel="stylesheet" type="text/css"/>
    <!--  END CUSTOM STYLE FILE  -->
    <link href="{% static 'assets/css/components/custom-modal.css' %}" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/jquery-step/jquery.steps.css' %}">
    <style>
        #formValidate .wizard > .content {
            min-height: 25em;
        }

        #example-vertical.wizard > .content {
            min-height: 24.5em;
        }
    </style>
{% endblock %}


<!-- Important for page rendering -->
{% block page_class %}sidebar-noneoverflow{% endblock %}
{% block page_title %}{% trans 'Add Booking' %}{% endblock %}
{% block page_title_heading %}{% trans 'Add Booking' %}{% endblock %}
<!-- ends here important tile and class -->


<!-- Start Adding Content From Here -->
{% block content %}
    <div class="layout-px-spacing col-12">
        <div class="row layout-top-spacing" id="cancel-row">
            <div class="col-xl-12 col-lg-12 col-sm-12  layout-spacing">
                <div class="widget-content widget-content-area br-6">
                    <form method="POST" action="{% url 'booking:add' %}">
                        {% if redirect_field_value %}
                            <input type="hidden" name="{{ redirect_field_name }}"
                                   value="{{ redirect_field_value }}"/>
                        {% endif %}
                        {% csrf_token %}

                        {{ form.non_field_errors }}
                        <div id="example-basic">

                            <h3>Location</h3>
                            <section>
                                <div class="input-group mb-3">
                                    {{ form.subject.errors }}
                                    {{ form.subject.label_tag }}
                                    <input type="text" class="form-control" id="id_address" name="address"
                                           placeholder="Address"
                                           aria-label="Recipient's username" aria-describedby="button-addon2">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" data-toggle="modal"
                                                data-target="#exampleModal" type="button" id="button-addon2">
                                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor"
                                                 stroke-width="2" fill="none" stroke-linecap="round"
                                                 stroke-linejoin="round"
                                                 class="css-i6dzq1">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                                <circle cx="12" cy="10" r="3"></circle>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div id="map" style="height: 400px;"></div>
                            </section>
                            <h3>Services</h3>
                            <section>

                                {{ form.service.errors }}
                                {{ form.service|as_crispy_field }}

                            </section>
                            <h3>Preferences</h3>
                            <section>
                                {{ form.customer|as_crispy_field }}
                                {{ form.staff|as_crispy_field }}
                                {{ form.access_arrangments|as_crispy_field }}
                                {{ form.key_no|as_crispy_field }}
                                {{ form.job_reference|as_crispy_field }}
                                {{ form.notes|as_crispy_field }}
                                {{ form.private_notes|as_crispy_field }}
                            </section>
                        </div>


                    </form>
                </div>
            </div>

        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Location Confirmation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    {{ AddressForm|crispy }}
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal"><i class="flaticon-cancel-12"></i> Save</button>

                </div>
            </div>
        </div>
    </div>
{% endblock %}
<!-- Main Content -->



{% block page_js %}

    <script src="{% static 'plugins/flatpickr/flatpickr.js' %}"></script>


    <script src="{% static 'plugins/flatpickr/custom-flatpickr.js' %}"></script>
    <script src="{% static 'plugins/jquery-step/jquery.steps.min.js' %}"></script>
    <script src="{% static 'plugins/jquery-step/custom-jquery.steps.js' %}"></script>
    <script>
        var f2 = flatpickr(document.getElementById('id_start_time'), {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
        });
        var f2 = flatpickr(document.getElementById('id_end_time'), {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
        });
    </script>

    <script>
        // This sample uses the Autocomplete widget to help the user select a
        // place, then it retrieves the address components associated with that
        // place, and then it populates the form fields with those details.
        // This sample requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script
        // src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

        var placeSearch, autocomplete;

        var componentForm = {
            id_street_name: 'short_name',
            id_details: 'long_name',
            id_state: 'long_name',
            id_suburb: 'short_name',
            id_country: 'long_name',
            id_postcode: 'short_name'
        };

        function initAutocomplete() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -33.8688, lng: 151.2195},
                zoom: 13,
                mapTypeId: 'roadmap'
            });
            // Create the autocomplete object, restricting the search predictions to
            // geographical location types.
            autocomplete = new google.maps.places.Autocomplete(
                document.getElementById('id_address'), {types: ['geocode']});

            // Avoid paying for data that you don't need by restricting the set of
            // place fields that are returned to just the address components.
            autocomplete.setFields(['address_component']);

            var input = document.getElementById('id_address')
            // Search Box Field
            var searchBox = new google.maps.places.SearchBox(input);


            // Bias the SearchBox results towards current map's viewport.
            map.addListener('bounds_changed', function () {

                searchBox.setBounds(map.getBounds());
            });

            // When the user selects an address from the drop-down, populate the
            // address fields in the form.
            autocomplete.addListener('place_changed', function () {
                fillInAddress();
                searchBox.setBounds(map.getBounds());
            });
            var markers = [];
            // Listen for the event fired when the user selects a prediction and retrieve
            // more details for that place.
            searchBox.addListener('places_changed', function () {

                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // Clear out the old markers.
                markers.forEach(function (marker) {
                    marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function (place) {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                        return;
                    }
                    var icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25)
                    };

                    // Create a marker for each place.
                    markers.push(new google.maps.Marker({
                        map: map,
                        icon: icon,
                        title: place.name,
                        position: place.geometry.location
                    }));

                    if (place.geometry.viewport) {
                        // Only geocodes have viewport.
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }

        function fillInAddress() {
            // Get the place details from the autocomplete object.
            var place = autocomplete.getPlace();
            console.log(place, componentForm);

            for (var component in componentForm) {
                document.getElementById(component).value = '';
                document.getElementById(component).disabled = false;
            }

            // Get each component of the address from the place details,
            // and then fill-in the corresponding field on the form.
            for (var i = 0; i < place.address_components.length; i++) {
                var addressType = place.address_components[i].types[0];
                console.log(addressType, componentForm[addressType]);
                if (addressType == "street_number") {
                    var val = place.address_components[i][componentForm['id_street_name']];
                    document.getElementById('id_street_name').value = val;
                }
                if (addressType == "route") {
                    var val = place.address_components[i][componentForm['id_details']];
                    document.getElementById('id_details').value = val;
                }
                if (addressType == "locality") {
                   // var val = place.address_components[i][componentForm['id_city']];
                   // document.getElementById('id_city').value = val;
                }
                if (addressType == "administrative_area_level_1") {
                    var val = place.address_components[i][componentForm['id_state']];
                    document.getElementById('id_state').value = val;
                }
                if (addressType == "country") {
                    var val = place.address_components[i][componentForm['id_country']];
                    document.getElementById('id_country').value = val;
                }

                if (addressType == "postal_code") {
                    var val = place.address_components[i][componentForm['id_postcode']];
                    document.getElementById('id_postcode').value = val;
                }


            }
        }


        // Bias the autocomplete object to the user's geographical location,
        // as supplied by the browser's 'navigator.geolocation' object.
        function geolocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var geolocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var circle = new google.maps.Circle(
                        {center: geolocation, radius: position.coords.accuracy});
                    autocomplete.setBounds(circle.getBounds());
                });
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADoLaI3Jlc2wVT-ISO-owBJvl3CSEjkCU&libraries=places&callback=initAutocomplete"
            async defer></script>
{% endblock %}